# ===================================================================
# apogee config v2 (modules-first)
#
# Goals:
#   - apogee detects context (platform, shell, host)
#   - modules decide if they are ACTIVE based on detection rules
#   - ONLY active modules emit env/paths/aliases/functions/snippets
#
# Philosophy:
#   - "global" should only contain things that depend on platform/shell,
#     not on whether Dropbox/git/etc exists.
#   - Anything that depends on an app/service/root path should live in a module.
#
# Detection model (per module):
#   - detect.paths.<platform>.any_of: folder exists -> module active
#   - detect.commands.any_of: command exists in PATH -> module active
#   - detect.files.<platform>.any_of: file/glob exists -> module active (desktop apps)
#   - detect.env.any_of: env var present -> module active (optional)
#
# Emission model (per module, only when active):
#   - emit.env: sets env vars (shell-specific export/set semantics handled by apogee)
#   - emit.paths: prepend/append PATH entries if they exist
#   - emit.aliases: aliases (or functions-on-fish if you choose)
#   - emit.functions: load functions (prefer files), and/or inline
# ===================================================================

[apogee]
schema_version = 2

default_shell  = "zsh"
platforms      = ["mac", "linux", "windows", "wsl", "other"]

# apogee reads these (in order) and merges into runtime env map:
env_file       = "{config_dir}/.env"
secrets_file   = "{config_dir}/secrets.env"

[apogee.bootstrap.defaults.env]
XDG_CONFIG_HOME = "{home}/.config"
XDG_CACHE_HOME  = "{home}/.cache"
XDG_DATA_HOME   = "{home}/.local/share"
XDG_STATE_HOME  = "{home}/.local/state"

[apogee.bootstrap.secrets]
strategy = "fill_missing" # "fill_missing" | "override"

[modules]
enable_cloud = true
enable_apps  = true
enable_hooks = true


# ===================================================================
# GLOBAL (platform/shell only)
# ===================================================================

[global]

[global.aliases.platform.mac]
o = "open ."

[global.aliases.platform.linux]
o = "xdg-open ."

[global.aliases.platform.windows]
o = "explorer.exe ."

[global.aliases.platform.wsl]
o = "explorer.exe ."

# ===================================================================
# MODULES: CLOUD
# ===================================================================

[modules.cloud]
enabled = true

# ===================================================================
# Dropbox
# ===================================================================

[modules.cloud.dropbox]
enabled   = true
kind      = "storage"
platforms = ["mac", "linux", "windows", "wsl", "other"]

[modules.cloud.dropbox.detect.paths.mac]
any_of = [
  "{home}/Library/CloudStorage/Dropbox",
  "{home}/Dropbox",
]

[modules.cloud.dropbox.detect.paths.linux]
any_of = ["{home}/Dropbox"]

[modules.cloud.dropbox.detect.paths.windows]
any_of = ["{userprofile}/Dropbox"]

[modules.cloud.dropbox.detect.paths.wsl]
any_of = [
  "{userprofile}/Dropbox",
  "/mnt/c/Users/{username}/Dropbox",
]

[modules.cloud.dropbox.detect.paths.other]
any_of = ["{home}/Dropbox"]

[modules.cloud.dropbox.emit.env]
DROPBOX = "{detect.path}"

[modules.cloud.dropbox.emit.env_derived]
MATRIX   = "$DROPBOX/matrix"
PACKAGES = "$MATRIX/packages"
CRATES   = "$MATRIX/crates"
DOCKER   = "$MATRIX/docker"

[modules.cloud.dropbox.emit.aliases]
matrix   = "cd \"$MATRIX\""
packages = "cd \"$PACKAGES\""
crates   = "cd \"$CRATES\""

orbit    = "cd \"$DROPBOX/matrix/orbit\""
helix    = "cd \"$DROPBOX/matrix/helix\""
tessera  = "cd \"$DROPBOX/matrix/tessera\""

apogee   = "cd \"$DROPBOX/matrix/crates/apogee\""
rusk     = "cd \"$DROPBOX/matrix/crates/rusk\""

[modules.cloud.dropbox.emit.paths]
prepend_if_exists = ["$DROPBOX/matrix/bin"]
append_if_exists  = []

# ===================================================================
# MODULES: APPS
# ===================================================================

[modules.apps]
enabled = true

# ----------------------
# git (CLI app)
# ----------------------
[modules.apps.git]
enabled   = true
kind      = "cli"
platforms = ["mac", "linux", "windows", "wsl", "other"]

[modules.apps.git.detect.commands]
any_of = ["git"]

[modules.apps.git.detect.version.all]
type = "command"
command = "git"
args = ["--version"]
regex = "(?P<version>[0-9]+\\.[0-9]+\\.[0-9]+)"

[modules.apps.git.emit.aliases]
gs = "git status"
gcp = "git_commit_push"

[modules.apps.git.emit.functions]
files = ["{xdg_config_home}/apogee/functions/git.sh"]

# ----------------------
# eza (CLI app)
# ----------------------
[modules.apps.eza]
enabled   = true
kind      = "cli"
platforms = ["mac", "linux", "windows", "wsl", "other"]

[modules.apps.eza.detect.commands]
any_of = ["eza"]

[modules.apps.eza.detect.version.all]
type = "command"
command = "eza"
args = ["--version"]
regex = "(?P<version>[0-9]+\\.[0-9]+\\.[0-9]+)"

[modules.apps.eza.emit.env]
USE_EZA = "1"

[modules.apps.eza.emit.aliases]
ls = "eza"
ll = "eza -l"
la = "eza -la"

# ----------------------
# Houdini (desktop app example)
# ----------------------
[modules.apps.houdini]
enabled   = false
kind      = "desktop"
platforms = ["mac", "linux", "windows"]

[modules.apps.houdini.detect.files.mac]
any_of = ["/Applications/Houdini*.app"]

[modules.apps.houdini.detect.files.linux]
any_of = ["/opt/hfs*"]

[modules.apps.houdini.detect.files.windows]
any_of = ["C:/Program Files/Side Effects Software/Houdini*"]

[modules.apps.houdini.detect.version.mac]
type = "path_regex"
regex = "Houdini\\s*(?P<version>[0-9]+\\.[0-9]+\\.[0-9]+).*\\.app$"

[modules.apps.houdini.detect.version.linux]
type = "path_regex"
regex = "hfs(?P<version>[0-9]+\\.[0-9]+\\.[0-9]+)$"

[modules.apps.houdini.detect.version.windows]
type = "path_regex"
regex = "Houdini\\s*(?P<version>[0-9]+\\.[0-9]+\\.[0-9]+)$"

# ===================================================================
# MODULES: HOOKS
# ===================================================================

[modules.hooks]
enabled = true

[[modules.hooks.items]]
name      = "after-core-mac"
enabled   = true
platforms = ["mac"]
shells    = ["zsh", "bash"]
script    = "{xdg_config_home}/apogee/hooks/after-core-mac.sh"

[[modules.hooks.items]]
name      = "after-core-linux"
enabled   = true
platforms = ["linux"]
hosts     = ["nimbus", "flicker", "nexus"]
shells    = ["zsh", "bash"]
script    = "{xdg_config_home}/apogee/hooks/after-core-linux.sh"
