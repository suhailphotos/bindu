# ===================================================================
# apogee config v2 (modules-first)
#
# Goals:
#   - apogee detects context (platform, shell, host)
#   - modules decide if they are ACTIVE based on detection rules
#   - ONLY active modules emit env/paths/aliases/functions/snippets
#
# Philosophy:
#   - "global" should only contain things that depend on platform/shell,
#     not on whether Dropbox/git/etc exists.
#   - Anything that depends on an app/service/root path should live in a module.
#
# Detection model (per module):
#   - detect.paths.<platform>.any_of: folder exists -> module active
#   - detect.commands.any_of: command exists in PATH -> module active
#   - detect.files.<platform>.any_of: file/glob exists -> module active (desktop apps)
#   - detect.env.any_of: env var present -> module active (optional)
#
# Emission model (per module, only when active):
#   - emit.env: sets env vars (shell-specific export/set semantics handled by apogee)
#   - emit.paths: prepend/append PATH entries if they exist
#   - emit.aliases: aliases (or functions-on-fish if you choose)
#   - emit.functions: load functions (prefer files), and/or inline
# ===================================================================

[apogee]
schema_version = 2

default_shell  = "zsh"
platforms      = ["mac", "linux", "windows", "wsl", "other"]

env_file       = "{config_dir}/.env"
secrets_file   = "{config_dir}/secrets.env"

[apogee.bootstrap.defaults.env]
XDG_CONFIG_HOME = "{home}/.config"
XDG_CACHE_HOME  = "{home}/.cache"
XDG_DATA_HOME   = "{home}/.local/share"
XDG_STATE_HOME  = "{home}/.local/state"

[apogee.bootstrap.secrets]
strategy = "fill_missing" # "fill_missing" | "override"


[modules]
enable_cloud = true
enable_apps  = true
enable_hooks = false


# ===================================================================
# GLOBAL (platform/shell only)
# ===================================================================

[global]

[global.aliases.platform.mac]
o = "open ."

[global.aliases.platform.linux]
o = "xdg-open ."

[global.aliases.platform.windows]
o = "explorer.exe ."

[global.aliases.platform.wsl]
o = "explorer.exe ."


# ===================================================================
# MODULES: CLOUD
# ===================================================================

[modules.cloud]
enabled = true

# -------------------------------------------------------------------
# dropbox  (Orbit: DROPBOX/MATRIX/DOCKER/BASE_DIR/PACKAGES/CRATES/OBSIDIAN)
# -------------------------------------------------------------------
[modules.cloud.dropbox]
enabled   = true
kind      = "storage"
platforms = ["mac", "linux", "windows", "wsl", "other"]

[modules.cloud.dropbox.detect.paths.mac]
any_of = [
  "{home}/Library/CloudStorage/Dropbox",
  "{home}/Dropbox",
]

[modules.cloud.dropbox.detect.paths.linux]
any_of = ["{home}/Dropbox"]

[modules.cloud.dropbox.detect.paths.windows]
any_of = ["{userprofile}/Dropbox"]

[modules.cloud.dropbox.detect.paths.wsl]
any_of = [
  "{userprofile}/Dropbox",
  "/mnt/c/Users/{username}/Dropbox",
]

[modules.cloud.dropbox.detect.paths.other]
any_of = ["{home}/Dropbox"]

[modules.cloud.dropbox.emit.env]
DROPBOX = "{detect.path}"

[modules.cloud.dropbox.emit.env_derived]
MATRIX   = "$DROPBOX/matrix"
DOCKER   = "$MATRIX/docker"
BASE_DIR = "$MATRIX/shellscripts"
PACKAGES = "$MATRIX/packages"
CRATES   = "$MATRIX/crates"
OBSIDIAN = "$MATRIX/obsidian/jnanaKosha"

[modules.cloud.dropbox.emit.aliases]
matrix   = "cd \"$MATRIX\""
packages = "cd \"$PACKAGES\""
crates   = "cd \"$CRATES\""

orbit    = "cd \"$DROPBOX/matrix/orbit\""
helix    = "cd \"$DROPBOX/matrix/helix\""
tessera  = "cd \"$DROPBOX/matrix/tessera\""

apogee   = "cd \"$DROPBOX/matrix/crates/apogee\""
rusk     = "cd \"$DROPBOX/matrix/crates/rusk\""

[modules.cloud.dropbox.emit.paths]
prepend_if_exists = ["$DROPBOX/matrix/bin"]
append_if_exists  = []


# -------------------------------------------------------------------
# dataLib  (your corrected paths)
# -------------------------------------------------------------------
[modules.cloud.dataLib]
enabled   = true
kind      = "storage"
platforms = ["mac", "linux", "windows", "wsl", "other"]

[modules.cloud.dataLib.detect.paths.mac]
any_of = [
  "{home}/Library/CloudStorage/SynologyDrive-dataLib",
  "{home}/dataLib",
]

[modules.cloud.dataLib.detect.paths.linux]
any_of = ["/mnt/dataLib"]

[modules.cloud.dataLib.detect.paths.windows]
any_of = ["{userprofile}/dataLib"]

[modules.cloud.dataLib.detect.paths.wsl]
any_of = [
  "{userprofile}/dataLib",
  "/mnt/c/Users/{username}/dataLib",
]

[modules.cloud.dataLib.detect.paths.other]
any_of = ["{home}/dataLib"]

[modules.cloud.dataLib.emit.env]
DATALIB = "{detect.path}"

[modules.cloud.dataLib.emit.env_derived]
ML4VFX = "$DATALIB/threeD/courses/05_Machine_Learning_in_VFX"


# ===================================================================
# MODULES: APPS
# ===================================================================

[modules.apps]
enabled = true

# --------------------------------------------------
# core_userpaths (Orbit: ~/.local/bin)
# --------------------------------------------------
[modules.apps.core_userpaths]
enabled   = true
kind      = "cli"
platforms = ["mac", "linux", "wsl", "other", "windows"]

[modules.apps.core_userpaths.detect.paths.mac]
any_of = ["{home}/.local/bin"]

[modules.apps.core_userpaths.detect.paths.linux]
any_of = ["{home}/.local/bin"]

[modules.apps.core_userpaths.detect.paths.wsl]
any_of = ["{home}/.local/bin"]

[modules.apps.core_userpaths.detect.paths.other]
any_of = ["{home}/.local/bin"]

# (optional) if you ever want it on native Windows too:
[modules.apps.core_userpaths.detect.paths.windows]
any_of = ["{userprofile}/.local/bin"]

[modules.apps.core_userpaths.emit.paths]
prepend_if_exists = ["{home}/.local/bin"]
append_if_exists  = []


# --------------------------------------------------
# core_homebrew (mac baseline PATH)
# --------------------------------------------------
[modules.apps.core_homebrew]
enabled   = true
kind      = "cli"
platforms = ["mac"]

[modules.apps.core_homebrew.detect.paths.mac]
any_of = ["/opt/homebrew/bin"]

[modules.apps.core_homebrew.emit.paths]
prepend_if_exists = [
  "{detect.path}",        # /opt/homebrew/bin
  "/opt/homebrew/sbin",
]
append_if_exists = []


# --------------------------------------------------
# core_editor (no scripts, no hooks)
# Priority: nvim -> vim -> vi (first present wins)
# --------------------------------------------------
[modules.apps.core_editor]
enabled = true
kind = "cli"
platforms = []

[modules.apps.core_editor.detect.commands]
any_of = ["nvim", "vim", "vi"]

[modules.apps.core_editor.emit.env]
EDITOR     = "{detect.command}"
VISUAL     = "{detect.command}"
GIT_EDITOR = "{detect.command}"


# ----------------------
# git (CLI app)
# ----------------------
[modules.apps.git]
enabled = true
kind = "cli"
platforms = []

[modules.apps.git.detect.commands]
any_of = ["git"]

[modules.apps.git.emit.aliases]
gs  = "git status"
gcp = "git_commit_push"
mb  = "merge_branch"
gbp = "git_blob_push"

[modules.apps.git.emit.functions]
files = [
  "{config_dir}/functions/git.{shell_family_ext}",
]


# ----------------------
# eza (CLI app)
# ----------------------
[modules.apps.eza]
enabled   = true
kind      = "cli"
platforms = ["mac", "linux", "windows", "wsl", "other"]

[modules.apps.eza.detect.commands]
any_of = ["eza"]

[modules.apps.eza.detect.version.all]
type = "command"
command = "eza"
args = ["--version"]
regex = "(?P<version>[0-9]+\\.[0-9]+\\.[0-9]+)"

[modules.apps.eza.emit.env]
USE_EZA            = "1"
EZA_CONFIG_DIR     = "{home}/.config/eza"
APOGEE_LS_ICONS    = "0"
APOGEE_DOTFILES_SGR = "90"

[modules.apps.eza.emit.functions]
files = [
  "{config_dir}/functions/eza.{shell_family_ext}",
]


# ----------------------
# cargo / rust (CLI toolchain)
# ----------------------
[modules.apps.cargo]
enabled = true
kind = "cli"
platforms = ["mac", "linux", "windows", "wsl", "other"]

[modules.apps.cargo.detect.commands]
any_of = ["cargo"]

[modules.apps.cargo.emit.env]
CARGO_TARGET_DIR = "{home}/.cache/cargo/targets"


# ----------------------
# starship (prompt)
# ----------------------
[modules.apps.starship]
enabled = true
kind = "cli"
platforms = ["mac", "linux", "windows", "wsl", "other"]

[modules.apps.starship.detect.commands]
any_of = ["starship"]

[[modules.apps.starship.emit.init]]
command = "{detect.command_path}"
args = ["init", "{shell_init}"]
pwsh_out_string = false


# ----------------------
# zoxide (smarter cd)
# ----------------------
[modules.apps.zoxide]
enabled = true
kind = "cli"
platforms = ["mac", "linux", "windows", "wsl", "other"]

[modules.apps.zoxide.detect.commands]
any_of = ["zoxide"]

[[modules.apps.zoxide.emit.init]]
command = "{detect.command_path}"
args = ["init", "{shell_init}"]
pwsh_out_string = true

# --------------------------------------------------
# pixi (CLI toolchain)
# Orbit: PIXI_HOME + PATH + host-manifest helpers
# --------------------------------------------------
[modules.apps.pixi]
enabled   = true
kind      = "cli"
platforms = ["mac", "linux", "windows", "wsl", "other"]

[modules.apps.pixi.detect.paths.mac]
any_of = ["{home}/.pixi"]

[modules.apps.pixi.detect.paths.linux]
any_of = ["{home}/.pixi"]

[modules.apps.pixi.detect.paths.windows]
any_of = ["{userprofile}/.pixi"]

[modules.apps.pixi.detect.paths.wsl]
any_of = [
  "{home}/.pixi",
  "/mnt/c/Users/{username}/.pixi",
]

[modules.apps.pixi.detect.paths.other]
any_of = ["{home}/.pixi"]

[modules.apps.pixi.emit.env]
PIXI_HOME = "{detect.path}"

[modules.apps.pixi.emit.paths]
prepend_if_exists = ["$PIXI_HOME/bin"]
append_if_exists  = []

[modules.apps.pixi.emit.env_derived]
PIXIH_HOST_TRACKED = "{xdg_config_home}/pixi/hosts/{host}/.pixi/manifests/pixi-global.toml"
PIXIH_LIVE_LINK    = "$PIXI_HOME/manifests/pixi-global.toml"

[modules.apps.pixi.emit.functions]
files = [
  "{config_dir}/functions/pixi.{shell_family_ext}",
]


# --------------------------------------------------
# uv (python tooling)
# --------------------------------------------------
[modules.apps.uv]
enabled   = true
kind      = "cli"
platforms = ["mac", "linux", "windows", "wsl", "other"]

[modules.apps.uv.detect.commands]
any_of = ["uv"]

[modules.apps.uv.emit.env]
# Apogee-managed knobs (replacing ORBIT_* names)
APOGEE_UV_VENV_ROOT   = "{home}/.venvs"
APOGEE_UV_DEFAULT_PY  = "auto-houdini"

# uvâ€™s own locations (keep the same defaults you used)
UV_TOOL_DIR      = "{home}/.local/share/uv/tools"
UV_TOOL_BIN_DIR  = "{home}/.local/share/uv/bin"

[modules.apps.uv.emit.paths]
prepend_if_exists = ["$UV_TOOL_BIN_DIR"]
append_if_exists  = []

[modules.apps.uv.emit.functions]
files = [
  "{config_dir}/functions/uv.{shell_ext}",
  "{config_dir}/functions/uv.{shell_family_ext}",
]

# ===================================================================
# MODULES: HOOKS (disabled by default)
# ===================================================================

[modules.hooks]
enabled = false

# [[modules.hooks.items]]
# name      = "after-core-mac"
# enabled   = true
# platforms = ["mac"]
# shells    = ["zsh", "bash"]
# script    = "{xdg_config_home}/apogee/hooks/after-core-mac.sh"

# [[modules.hooks.items]]
# name      = "after-core-linux"
# enabled   = true
# platforms = ["linux"]
# hosts     = ["nimbus", "flicker", "nexus"]
# shells    = ["zsh", "bash"]
# script    = "{xdg_config_home}/apogee/hooks/after-core-linux.sh"
